// Generated by CoffeeScript 1.4.0
(function() {
  var gRawMaps, handleEvent, initMain, moveObject, newGame, redrawTile;

  gRawMaps = [["xxxx#####", "xxxx#   #", "xxxx#o  #", "xx###  o##", "xx#  o o #", "### # ## #xxx######", "#   # ## #####  ..#", "# o  o          ..#", "##### ### #@##  ..#", "xxxx#     #########", "xxxx#######"], ["############", "#..  #     ###", "#..  # o  o  #", "#..  #o####  #", "#..    @ ##  #", "#..  # #  o ##", "###### ##o o #", "xx# o  o o o #", "xx#    #     #", "xx############"], ["xxxxxxxx########", "xxxxxxxx#     @#", "xxxxxxxx# o#o ##", "xxxxxxxx# o  o#", "xxxxxxxx##o o #", "######### o # ###", "#....  ## o  o  #", "##...    o  o   #", "#....  ##########", "########"], ["xxxxxxxxxxx########", "xxxxxxxxxxx#  ....#", "############  ....#", "#    #  o o   ....#", "# ooo#o  o #  ....#", "#  o     o #  ....#", "# oo #o o o########", "#  o #     #", "## #########", "#    #    ##", "#     o   ##", "#  oo#oo  @#", "#    #    ##", "###########"], ["xxxxxxxx#####", "xxxxxxxx#   #####", "xxxxxxxx# #o##  #", "xxxxxxxx#     o #", "######### ###   #", "#....  ## o  o###", "#....    o oo ##", "#....  ##o  o @#", "#########  o  ##", "xxxxxxxx# o o  #", "xxxxxxxx### ## #", "xxxxxxxxxx#    #", "xxxxxxxxxx######"], ["######xx###", "#..  #x##@##", "#..  ###   #", "#..     oo #", "#..  # # o #", "#..### # o #", "#### o #o  #", "xxx#  o# o #", "xxx# o  o  #", "xxx#  ##   #", "xxx#########"], ["xxxxxxx#####", "x#######   ##", "## # @## oo #", "#    o      #", "#  o  ###   #", "### #####o###", "# o  ### ..#", "# o o o ...#", "#    ###...#", "# oo # #...#", "#  ### #####", "####"], ["xx####", "xx#  ###########", "xx#    o   o o #", "xx# o# o #  o  #", "xx#  o o  #    #", "### o# #  #### #", "#@#o o o  ##   #", "#    o #o#   # #", "#   o    o o o #", "#####  #########", "xx#      #", "xx#      #", "xx#......#", "xx#......#", "xx#......#", "xx########"], ["xxxxxxxxxx#######", "xxxxxxxxxx#  ...#", "xxxxxx#####  ...#", "xxxxxx#      . .#", "xxxxxx#  ##  ...#", "xxxxxx## ##  ...#", "xxxxx### ########", "xxxxx# ooo ##", "x#####  o o #####", "##   #o o   #   #", "#@ o  o    o  o #", "###### oo o #####", "xxxxx#      #", "xxxxx########"], [" ###  #############", "##@####       #   #", "# oo   oo  o o ...#", "#  ooo#    o  #...#", "# o   # oo oo #...#", "###   #  o    #...#", "#     # o o o #...#", "#    ###### ###...#", "## #  #  o o  #...#", "#  ## # oo o o##..#", "# ..# #  o      #.#", "# ..# # ooo ooo #.#", "##### #       # #.#", "    # ######### #.#", "    #           #.#", "    ###############"], ["          ####", "     #### #  #", "   ### @###o #", "  ##      o  #", " ##  o oo## ##", " #  #o##     #", " # # o oo # ###", " #   o #  # o #####", "####    #  oo #   #", "#### ## o         #", "#.    ###  ########", "#.. ..# ####", "#...#.#", "#.....#", "#######"], ["################", "#              #", "# # ######     #", "# #  o o o o#  #", "# #   o@o   ## ##", "# #  o o o###...#", "# #   o o  ##...#", "# ###ooo o ##...#", "#     # ## ##...#", "#####   ## ##...#", "    #####     ###", "        #     #", "        #######"], ["   #########", "  ##   ##  #####", "###     #  #    ###", "#  o #o #  #  ... #", "# # o#@o## # #.#. #", "#  # #o  #    . . #", "# o    o # # #.#. #", "#   ##  ##o o . . #", "# o #   #  #o#.#. #", "## o  o   o  o... #", " #o ######    ##  #", " #  #    ##########", " ####"], ["       #######", " #######     #", " #     # o@o #", " #oo #   #########", " # ###......##   #", " #   o......## # #", " # ###......     #", "##   #### ### #o##", "#  #o   #  o  # #", "#  o ooo  # o## #", "#   o o ###oo # #", "#####     o   # #", "    ### ###   # #", "      #     #   #", "      ########  #", "             ####"], ["   ########", "   #   #  #", "   #  o   #", " ### #o   ####", " #  o  ##o   #", " #  # @ o # o#", " #  #      o ####", " ## ####o##     #", " # o#.....# #   #", " #  o..**. o# ###", "##  #.....#   #", "#   ### #######", "# oo  #  #", "#  #     #", "######   #", "     #####"], ["#####", "#   ##", "#    #  ####", "# o  ####  #", "#  oo o   o#", "###@ #o    ##", " #  ##  o o ##", " # o  ## ## .#", " #  #o##o  #.#", " ###   o..##.#", "  #    #.*...#", "  # oo #.....#", "  #  #########", "  #  #", "  ####"], ["   ##########", "   #..  #   #", "   #..      #", "   #..  #  ####", "  #######  #  ##", "  #            #", "  #  #  ##  #  #", "#### ##  #### ##", "#  o  ##### #  #", "# # o  o  # o  #", "# @o  o   #   ##", "#### ## #######", "   #    #", "   ######"], ["     ###########", "     #  .  #   #", "     # #.    @ #", " ##### ##..# ####", "##  # ..###     ###", "# o #...   o #  o #", "#    .. ##  ## ## #", "####o##o# o #   # #", "  ## #    #o oo # #", "  #  o # #  # o## #", "  #               #", "  #  ###########  #", "  ####         ####"], ["  ######", "  #   @####", "##### o   #", "#   ##    ####", "# o #  ##    #", "# o #  ##### #", "## o  o    # #", "## o o ### # #", "## #  o  # # #", "## # #o#   # #", "## ###   # # ######", "#  o  #### # #....#", "#    o    o   ..#.#", "####o  o# o   ....#", "#       #  ## ....#", "###################"], ["    ##########", "#####        ####", "#     #   o  #@ #", "# #######o####  ###", "# #    ## #  #o ..#", "# # o     #  #  #.#", "# # o  #     #o ..#", "# #  ### ##     #.#", "# ###  #  #  #o ..#", "# #    #  ####  #.#", "# #o   o  o  #o ..#", "#    o # o o #  #.#", "#### o###    #o ..#", "   #    oo ###....#", "   #      ## ######", "   ########"], ["#########", "#       #", "#       ####", "## #### #  #", "## #@##    #", "# ooo o  oo#", "#  # ## o  #", "#  # ##  o ####", "####  ooo o#  #", " #   ##   ....#", " # #   # #.. .#", " #   # # ##...#", " ##### o  #...#", "     ##   #####", "      #####"], ["######     ####", "#    #######  #####", "#   o#  #  o  #   #", "#  o  o  o # o o  #", "##o o   # @# o    #", "#  o ########### ##", "# #   #.......# o#", "# ##  # ......#  #", "# #   o........o #", "# # o #.... ..#  #", "#  o o####o#### o#", "# o   ### o   o  ##", "# o     o o  o    #", "## ###### o ##### #", "#         #       #", "###################"], ["    #######", "    #  #  ####", "##### o#o #  ##", "#.. #  #  #   #", "#.. # o#o #  o####", "#.  #     #o  #  #", "#..   o#  # o    #", "#..@#  #o #o  #  #", "#.. # o#     o#  #", "#.. #  #oo#o  #  ##", "#.. # o#  #  o#o  #", "#.. #  #  #   #   #", "##. ####  #####   #", " ####  ####   #####"], ["###############", "#..........  .####", "#..........oo.#  #", "###########o #   ##", "#      o  o     o #", "## ####   #  o #  #", "#      #   ##  # ##", "#  o#  # ##  ### ##", "# o #o###    ### ##", "###  o #  #  ### ##", "###    o ## #  # ##", " # o  #  o  o o   #", " #  o  o#ooo  #   #", " #  #  o      #####", " # @##  #  #  #", " ##############"], ["####", "#  ##############", "#  #   ..#......#", "#  # # ##### ...#", "##o#    ........#", "#   ##o######  ####", "# o #     ######@ #", "##o # o   ######  #", "#  o #ooo##       #", "#      #    #o#o###", "# #### #ooooo    #", "# #    o     #   #", "# #   ##        ###", "# ######o###### o #", "#        #    #   #", "##########    #####"], [" #######", " #  #  #####", "##  #  #...###", "#  o#  #...  #", "# o #oo ...  #", "#  o#  #... .#", "#   # o########", "##o       o o #", "##  #  oo #   #", " ######  ##oo@#", "      #      ##", "      ########"], [" #################", " #...   #    #   ##", "##.....  o## # #o #", "#......#  o  #    #", "#......#  #  # #  #", "######### o  o o  #", "  #     #o##o ##o##", " ##   o    # o    #", " #  ## ### #  ##o #", " # o oo     o  o  #", " # o    o##o ######", " #######  @ ##", "       ######"], ["         #####", "     #####   #", "    ## o  o  ####", "##### o  o o ##.#", "#       oo  ##..#", "#  ###### ###.. #", "## #  #    #... #", "# o   #    #... #", "#@ #o ## ####...#", "####  o oo  ##..#", "   ##  o o  o...#", "    # oo  o #  .#", "    #   o o  ####", "    ######   #", "         #####"], ["#####", "#   ##", "# o  #########", "## # #       ######", "## #   o#o#@  #   #", "#  #      o #   o #", "#  ### ######### ##", "#  ## ..*..... # ##", "## ## *.*..*.* # ##", "# o########## ##o #", "#  o   o  o    o  #", "#  #   #   #   #  #", "###################"], ["       ###########", "       #   #     #", "#####  #     o o #", "#   ##### o## # ##", "# o ##   # ## o  #", "# o  @oo # ##ooo #", "## ###   # ##    #", "## #   ### #####o#", "## #     o  #....#", "#  ### ## o #....##", "# o   o #   #..o. #", "#  ## o #  ##.... #", "#####   ######...##", "    #####    #####"], ["  ####", "  #  #########", " ##  ##  #   #", " #  o# o@o   ####", " #o  o  # o o#  ##", "##  o## #o o     #", "#  #  # #   ooo  #", "# o    o  o## ####", "# o o #o#  #  #", "##  ###  ###o #", " #  #....     #", " ####......####", "   #....####", "   #...##", "   #...#", "   #####"], ["      ####", "  #####  #", " ##     o#", "## o  ## ###", "#@o o # o  #", "#### ##   o#", " #....#o o #", " #....#   o#", " #....  oo ##", " #... # o   #", " ######o o  #", "      #   ###", "      #o ###", "      #  #", "      ####"], [" ###########", " #     ##  #", " #   o   o #", "#### ## oo #", "#   o #    #", "# ooo # ####", "#   # # o ##", "#  #  #  o #", "# o# o#    #", "#   ..# ####", "####.. o #@#", "#.....# o# #", "##....#  o #", " ##..##    #", "  ##########"], [" #########", " #....   ##", " #.#.#  o ##", "##....# # @##", "# ....#  #  ##", "#     #o ##o #", "## ###  o    #", " #o  o o o#  #", " # #  o o ## #", " #  ###  ##  #", " #    ## ## ##", " #  o #  o  #", " ###o o   ###", "   #  #####", "   ####"], ["############ ######", "#   #    # ###....#", "#   oo#   @  .....#", "#   # ###   # ....#", "## ## ###  #  ....#", " # o o     # # ####", " #  o o##  #      #", "#### #  #### # ## #", "#  # #o   ## #    #", "# o  o  # ## #   ##", "# # o o    # #   #", "#  o ## ## # #####", "# oo     oo  #", "## ## ### o  #", " #    # #    #", " ###### ######"], ["            #####", "#####  ######   #", "#   ####  o o o #", "# o   ## ## ##  ##", "#   o o     o  o #", "### o  ## ##     ##", "  # ##### #####oo #", " ##o##### @##     #", " # o  ###o### o  ##", " # o  #   ###  ###", " # oo o #   oo #", " #     #   ##  #", " #######.. .###", "    #.........#", "    #.........#", "    ###########"], ["###########", "#......   #########", "#......   #  ##   #", "#..### o    o     #", "#... o o #   ##   #", "#...#o#####    #  #", "###    #   #o  #o #", "  #  oo o o  o##  #", "  #  o   #o#o ##o #", "  ### ## #    ##  #", "   #  o o ## ######", "   #    o  o  #", "   ##   # #   #", "    #####@#####", "        ###"], ["      ####", "####### @#", "#     o  #", "#   o## o#", "##o#...# #", " # o...  #", " # #. .# ##", " #   # #o #", " #o  o    #", " #  #######", " ####"], ["             ######", " #############....#", "##   ##     ##....#", "#  oo##  o @##....#", "#      oo o#  ....#", "#  o ## oo # # ...#", "#  o ## o  #  ....#", "## ##### ### ##.###", "##   o  o ##   .  #", "# o###  # ##### ###", "#   o   #       #", "#  o #o o o###  #", "# ooo# o   # ####", "#    #  oo #", "######   ###", "     #####"], ["    ############", "    #          ##", "    #  # #oo o  #", "    #o #o#  ## @#", "   ## ## # o # ##", "   #   o #o  # #", "   #   # o   # #", "   ## o o   ## #", "   #  #  ##  o #", "   #    ## oo# #", "######oo   #   #", "#....#  ########", "#.#... ##", "#....   #", "#....   #", "#########"], ["           #####", "          ##   ##", "         ##     #", "        ##  oo  #", "       ## oo  o #", "       # o    o #", "####   #   oo #####", "#  ######## ##    #", "#.            ooo@#", "#.# ####### ##   ##", "#.# #######. #o o##", "#........... #    #", "##############  o #", "             ##  ##", "              ####"], ["     ########", "  ####      ######", "  #    ## o o   @#", "  # ## ##o#o o o##", "### ......#  oo ##", "#   ......#  #   #", "# # ......#o  o  #", "# #o...... oo# o #", "#   ### ###o  o ##", "###  o  o  o  o #", "  #  o  o  o  o #", "  ######   ######", "       #####"], ["        #######", "    #####  #  ####", "    #   #   o    #", " #### #oo ## ##  #", "##      # #  ## ###", "#  ### o#o  o  o  #", "#...    # ##  #   #", "#...#    @ # ### ##", "#...#  ###  o  o  #", "######## ##   #   #", "          #########"], [" #####", " #   #", " # # #######", " #      o@######", " # o ##o ###   #", " # #### o    o #", " # ##### #  #o ####", "##  #### ##o      #", "#  o#  o  # ## ## #", "#         # #...# #", "######  ###  ...  #", "     #### # #...# #", "          # ### # #", "          #       #", "          #########"], ["##### ####", "#...# #  ####", "#...###  o  #", "#....## o  o###", "##....##   o  #", "###... ## o o #", "# ##    #  o  #", "#  ## # ### ####", "# o # #o  o    #", "#  o @ o    o  #", "#   # o oo o ###", "#  ######  ###", "# ##    ####", "###"], ["##########", "#        ####", "# ###### #  ##", "# # o o o  o #", "#       #o   #", "###o  oo#  ###", "  #  ## # o##", "  ##o#   o @#", "   #  o o ###", "   # #   o  #", "   # ##   # #", "  ##  ##### #", "  #         #", "  #.......###", "  #.......#", "  #########"], ["         ####", " #########  ##", "##  o      o #####", "#   ## ##   ##...#", "# #oo o oo#o##...#", "# #   @   #   ...#", "#  o# ###oo   ...#", "# o  oo  o ##....#", "###o       #######", "  #  #######", "  ####"], ["  #########", "  #*.*#*.*#", "  #.*.*.*.#", "  #*.*.*.*#", "  #.*.*.*.#", "  #*.*.*.*#", "  ###   ###", "    #   #", "###### ######", "#           #", "# o o o o o #", "## o o o o ##", " #o o o o o#", " #   o@o   #", " #  #####  #", " ####   ####"], ["       ####", "       #  ##", "       #   ##", "       # oo ##", "     ###o  o ##", "  ####    o   #", "###  # #####  #", "#    # #....o #", "# #   o ....# #", "#  o # #.*..# #", "###  #### ### #", "  #### @o  ##o##", "     ### o     #", "       #  ##   #", "       #########"], ["      ############", "     ##..    #   #", "    ##..* o    o #", "   ##..*.# # # o##", "   #..*.# # # o  #", "####...#  #    # #", "#  ## #          #", "# @o o ###  #   ##", "# o   o   # #   #", "###oo   # # # # #", "  #   o   # # #####", "  # o# #####      #", "  #o   #   #    # #", "  #  ###   ##     #", "  #  #      #    ##", "  ####      ######"]];

  redrawTile = function(canvas, y, x, token) {
    if (token == null) {
      token = canvas.map[y][x];
    }
    return canvas.getContext("2d").drawImage(canvas.image, token * canvas.tilesize, 0, canvas.tilesize, canvas.tilesize, x * canvas.tilesize, y * canvas.tilesize, canvas.tilesize, canvas.tilesize);
  };

  newGame = function() {
    var canvas, canvasContext, gPlayerPos, thisMap, tmparr, token, x, y, _i, _j, _ref, _ref1;
    canvas = document.getElementById("sokoban");
    canvasContext = canvas.getContent("2d");
    if (canvas.level === "random") {
      thisMap = gRawMaps[Math.floor(Math.random() * gRawMaps.length)];
    } else {
      thisMap = gRawMaps[canvas.level];
    }
    canvasContext.fillStyle = "grey";
    canvasContext.fillRect(0, 0, canvas.width, canvas.height);
    canvas.map = [];
    tmparr = [];
    for (y = _i = 0, _ref = thisMap.length; 0 <= _ref ? _i < _ref : _i > _ref; y = 0 <= _ref ? ++_i : --_i) {
      for (x = _j = 0, _ref1 = thisMap[y].length; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; x = 0 <= _ref1 ? ++_j : --_j) {
        switch (thisMap[y][x]) {
          case ' ':
            token = 0;
            break;
          case '#':
            token = 1;
            break;
          case 'o':
            token = 2;
            break;
          case '*':
            token = 3;
            break;
          case '@':
            token = 4;
            gPlayerPos = [y, x];
            break;
          case '+':
            token = 5;
            break;
          case '.':
            token = 6;
            break;
          case 'x':
            token = 9;
        }
        tmparr.push(token);
        if (token !== 9) {
          redrawTile(canvas, y, x, token);
        }
      }
      gMap.push(tmparr);
      tmparr = [];
    }
    canvasContext.fillStyle = "black";
    return canvasContext.fillText("Level: " + (canvas.level + 1) + " (press space to reset level)", 0, canvas.height - canvas.tilesize(-5));
  };

  moveObject = function(canvas, dy, dx, objectType) {
    var gPlayerPos, objX, objY, x, y, _i, _j, _ref, _ref1, _ref2, _ref3;
    objY = canvas.playerPos[0];
    objX = canvas.playerPos[1];
    if (objectType === "crate") {
      objY += dy;
      objX += dx;
    }
    switch (canvas.map[objY + dy][objX + dx]) {
      case 1:
      case 2:
      case 3:
      case 4:
      case 5:
        return;
    }
    switch (canvas.map[objY][objX]) {
      case 2:
      case 4:
        canvas.map[objY][objX] = 0;
        break;
      case 3:
      case 5:
        canvas.map[objY][objX] = 6;
    }
    if (objectType === "player") {
      redrawTile(objY, objX);
    }
    objY += dy;
    objX += dx;
    switch (canvas.map[objY][objX]) {
      case 0:
        canvas.map[objY][objX] = (_ref = objectType === "crate") != null ? _ref : {
          2: 4
        };
        break;
      case 6:
        canvas.map[objY][objX] = (_ref1 = objectType === "crate") != null ? _ref1 : {
          3: 5
        };
    }
    redrawTile(objY, objX);
    if (objectType === "player") {
      return gPlayerPos = [objY, objX];
    } else if (objectType === "crate") {
      if (canvas.map[objY][objX] === 3) {
        for (y = _i = 0, _ref2 = canvas.map.length; 0 <= _ref2 ? _i < _ref2 : _i > _ref2; y = 0 <= _ref2 ? ++_i : --_i) {
          for (x = _j = 0, _ref3 = canvas.map[y].length; 0 <= _ref3 ? _j < _ref3 : _j > _ref3; x = 0 <= _ref3 ? ++_j : --_j) {
            if (canvavs.map[y][x] === 2) {
              return;
            }
          }
        }
        return newGame(++canvas.level);
      }
    }
  };

  handleEvent = function(event) {
    var canvas, dx, dy;
    canvas = document.getElementById("sokoban");
    switch (event.keyCode) {
      case 97:
      case 104:
        dx = -1;
        dy = 0;
        break;
      case 115:
      case 106:
        dx = 0;
        dy = 1;
        break;
      case 119:
      case 107:
        dx = 0;
        dy = -1;
        break;
      case 100:
      case 108:
        dx = 1;
        dy = 0;
        break;
      case 32:
        newGame(canvas.map);
        return;
      default:
        return;
    }
    switch (canvas.map[gPlayerPos[0] + dy][gPlayerPos[1] + dx]) {
      case 0:
        return moveObject(canvas, dy, dx, "player");
      case 2:
      case 3:
        moveObject(canvas, dy, dx, "crate");
        return moveObject(canvas, dy, dx, "player");
      case 6:
        return moveObject(canvas, dy, dx, "player");
    }
  };

  initMain = function(level) {
    var image;
    image = new Image();
    image.src = "tiles.png";
    image.onload = function() {
      var canvas, gCanvasContext;
      canvas = document.getElementById("sokoban");
      canvas.width = 400;
      canvas.height = 400;
      canvas.tilesize = 20;
      canvas.image = image;
      canvas.level = level;
      canvas.addEventListener("keypress", handleEvent, false);
      canvas.focus();
      gCanvasContext = canvas.getContext("2d");
      gCanvasContext.font = "bold " + TILE_SIZE + "px sans-serif";
      return gCanvasContext.textBaseline = "top";
    };
    return newGame(canvas.level);
  };

}).call(this);
