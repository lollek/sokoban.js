// Generated by CoffeeScript 1.4.0
(function() {
  var Sokoban, gRawMaps;

  gRawMaps = [["xxxx#####", "xxxx#   #", "xxxx#o  #", "xx###  o##", "xx#  o o #", "### # ## #xxx######", "#   # ## #####  ..#", "# o  o          ..#", "##### ### #@##  ..#", "xxxx#     #########", "xxxx#######"], ["############", "#..  #     ###", "#..  # o  o  #", "#..  #o####  #", "#..    @ ##  #", "#..  # #  o ##", "###### ##o o #", "xx# o  o o o #", "xx#    #     #", "xx############"], ["xxxxxxxx########", "xxxxxxxx#     @#", "xxxxxxxx# o#o ##", "xxxxxxxx# o  o#", "xxxxxxxx##o o #", "######### o # ###", "#....  ## o  o  #", "##...    o  o   #", "#....  ##########", "########"], ["xxxxxxxxxxx########", "xxxxxxxxxxx#  ....#", "############  ....#", "#    #  o o   ....#", "# ooo#o  o #  ....#", "#  o     o #  ....#", "# oo #o o o########", "#  o #     #", "## #########", "#    #    ##", "#     o   ##", "#  oo#oo  @#", "#    #    ##", "###########"], ["xxxxxxxx#####", "xxxxxxxx#   #####", "xxxxxxxx# #o##  #", "xxxxxxxx#     o #", "######### ###   #", "#....  ## o  o###", "#....    o oo ##", "#....  ##o  o @#", "#########  o  ##", "xxxxxxxx# o o  #", "xxxxxxxx### ## #", "xxxxxxxxxx#    #", "xxxxxxxxxx######"], ["######xx###", "#..  #x##@##", "#..  ###   #", "#..     oo #", "#..  # # o #", "#..### # o #", "#### o #o  #", "xxx#  o# o #", "xxx# o  o  #", "xxx#  ##   #", "xxx#########"], ["xxxxxxx#####", "x#######   ##", "## # @## oo #", "#    o      #", "#  o  ###   #", "### #####o###", "# o  ### ..#", "# o o o ...#", "#    ###...#", "# oo # #...#", "#  ### #####", "####"], ["xx####", "xx#  ###########", "xx#    o   o o #", "xx# o# o #  o  #", "xx#  o o  #    #", "### o# #  #### #", "#@#o o o  ##   #", "#    o #o#   # #", "#   o    o o o #", "#####  #########", "xx#      #", "xx#      #", "xx#......#", "xx#......#", "xx#......#", "xx########"], ["xxxxxxxxxx#######", "xxxxxxxxxx#  ...#", "xxxxxx#####  ...#", "xxxxxx#      . .#", "xxxxxx#  ##  ...#", "xxxxxx## ##  ...#", "xxxxx### ########", "xxxxx# ooo ##", "x#####  o o #####", "##   #o o   #   #", "#@ o  o    o  o #", "###### oo o #####", "xxxxx#      #", "xxxxx########"], [" ###  #############", "##@####       #   #", "# oo   oo  o o ...#", "#  ooo#    o  #...#", "# o   # oo oo #...#", "###   #  o    #...#", "#     # o o o #...#", "#    ###### ###...#", "## #  #  o o  #...#", "#  ## # oo o o##..#", "# ..# #  o      #.#", "# ..# # ooo ooo #.#", "##### #       # #.#", "    # ######### #.#", "    #           #.#", "    ###############"], ["          ####", "     #### #  #", "   ### @###o #", "  ##      o  #", " ##  o oo## ##", " #  #o##     #", " # # o oo # ###", " #   o #  # o #####", "####    #  oo #   #", "#### ## o         #", "#.    ###  ########", "#.. ..# ####", "#...#.#", "#.....#", "#######"], ["################", "#              #", "# # ######     #", "# #  o o o o#  #", "# #   o@o   ## ##", "# #  o o o###...#", "# #   o o  ##...#", "# ###ooo o ##...#", "#     # ## ##...#", "#####   ## ##...#", "    #####     ###", "        #     #", "        #######"], ["   #########", "  ##   ##  #####", "###     #  #    ###", "#  o #o #  #  ... #", "# # o#@o## # #.#. #", "#  # #o  #    . . #", "# o    o # # #.#. #", "#   ##  ##o o . . #", "# o #   #  #o#.#. #", "## o  o   o  o... #", " #o ######    ##  #", " #  #    ##########", " ####"], ["       #######", " #######     #", " #     # o@o #", " #oo #   #########", " # ###......##   #", " #   o......## # #", " # ###......     #", "##   #### ### #o##", "#  #o   #  o  # #", "#  o ooo  # o## #", "#   o o ###oo # #", "#####     o   # #", "    ### ###   # #", "      #     #   #", "      ########  #", "             ####"], ["   ########", "   #   #  #", "   #  o   #", " ### #o   ####", " #  o  ##o   #", " #  # @ o # o#", " #  #      o ####", " ## ####o##     #", " # o#.....# #   #", " #  o..**. o# ###", "##  #.....#   #", "#   ### #######", "# oo  #  #", "#  #     #", "######   #", "     #####"], ["#####", "#   ##", "#    #  ####", "# o  ####  #", "#  oo o   o#", "###@ #o    ##", " #  ##  o o ##", " # o  ## ## .#", " #  #o##o  #.#", " ###   o..##.#", "  #    #.*...#", "  # oo #.....#", "  #  #########", "  #  #", "  ####"], ["   ##########", "   #..  #   #", "   #..      #", "   #..  #  ####", "  #######  #  ##", "  #            #", "  #  #  ##  #  #", "#### ##  #### ##", "#  o  ##### #  #", "# # o  o  # o  #", "# @o  o   #   ##", "#### ## #######", "   #    #", "   ######"], ["     ###########", "     #  .  #   #", "     # #.    @ #", " ##### ##..# ####", "##  # ..###     ###", "# o #...   o #  o #", "#    .. ##  ## ## #", "####o##o# o #   # #", "  ## #    #o oo # #", "  #  o # #  # o## #", "  #               #", "  #  ###########  #", "  ####         ####"], ["  ######", "  #   @####", "##### o   #", "#   ##    ####", "# o #  ##    #", "# o #  ##### #", "## o  o    # #", "## o o ### # #", "## #  o  # # #", "## # #o#   # #", "## ###   # # ######", "#  o  #### # #....#", "#    o    o   ..#.#", "####o  o# o   ....#", "#       #  ## ....#", "###################"], ["    ##########", "#####        ####", "#     #   o  #@ #", "# #######o####  ###", "# #    ## #  #o ..#", "# # o     #  #  #.#", "# # o  #     #o ..#", "# #  ### ##     #.#", "# ###  #  #  #o ..#", "# #    #  ####  #.#", "# #o   o  o  #o ..#", "#    o # o o #  #.#", "#### o###    #o ..#", "   #    oo ###....#", "   #      ## ######", "   ########"], ["#########", "#       #", "#       ####", "## #### #  #", "## #@##    #", "# ooo o  oo#", "#  # ## o  #", "#  # ##  o ####", "####  ooo o#  #", " #   ##   ....#", " # #   # #.. .#", " #   # # ##...#", " ##### o  #...#", "     ##   #####", "      #####"], ["######     ####", "#    #######  #####", "#   o#  #  o  #   #", "#  o  o  o # o o  #", "##o o   # @# o    #", "#  o ########### ##", "# #   #.......# o#", "# ##  # ......#  #", "# #   o........o #", "# # o #.... ..#  #", "#  o o####o#### o#", "# o   ### o   o  ##", "# o     o o  o    #", "## ###### o ##### #", "#         #       #", "###################"], ["    #######", "    #  #  ####", "##### o#o #  ##", "#.. #  #  #   #", "#.. # o#o #  o####", "#.  #     #o  #  #", "#..   o#  # o    #", "#..@#  #o #o  #  #", "#.. # o#     o#  #", "#.. #  #oo#o  #  ##", "#.. # o#  #  o#o  #", "#.. #  #  #   #   #", "##. ####  #####   #", " ####  ####   #####"], ["###############", "#..........  .####", "#..........oo.#  #", "###########o #   ##", "#      o  o     o #", "## ####   #  o #  #", "#      #   ##  # ##", "#  o#  # ##  ### ##", "# o #o###    ### ##", "###  o #  #  ### ##", "###    o ## #  # ##", " # o  #  o  o o   #", " #  o  o#ooo  #   #", " #  #  o      #####", " # @##  #  #  #", " ##############"], ["####", "#  ##############", "#  #   ..#......#", "#  # # ##### ...#", "##o#    ........#", "#   ##o######  ####", "# o #     ######@ #", "##o # o   ######  #", "#  o #ooo##       #", "#      #    #o#o###", "# #### #ooooo    #", "# #    o     #   #", "# #   ##        ###", "# ######o###### o #", "#        #    #   #", "##########    #####"], [" #######", " #  #  #####", "##  #  #...###", "#  o#  #...  #", "# o #oo ...  #", "#  o#  #... .#", "#   # o########", "##o       o o #", "##  #  oo #   #", " ######  ##oo@#", "      #      ##", "      ########"], [" #################", " #...   #    #   ##", "##.....  o## # #o #", "#......#  o  #    #", "#......#  #  # #  #", "######### o  o o  #", "  #     #o##o ##o##", " ##   o    # o    #", " #  ## ### #  ##o #", " # o oo     o  o  #", " # o    o##o ######", " #######  @ ##", "       ######"], ["         #####", "     #####   #", "    ## o  o  ####", "##### o  o o ##.#", "#       oo  ##..#", "#  ###### ###.. #", "## #  #    #... #", "# o   #    #... #", "#@ #o ## ####...#", "####  o oo  ##..#", "   ##  o o  o...#", "    # oo  o #  .#", "    #   o o  ####", "    ######   #", "         #####"], ["#####", "#   ##", "# o  #########", "## # #       ######", "## #   o#o#@  #   #", "#  #      o #   o #", "#  ### ######### ##", "#  ## ..*..... # ##", "## ## *.*..*.* # ##", "# o########## ##o #", "#  o   o  o    o  #", "#  #   #   #   #  #", "###################"], ["       ###########", "       #   #     #", "#####  #     o o #", "#   ##### o## # ##", "# o ##   # ## o  #", "# o  @oo # ##ooo #", "## ###   # ##    #", "## #   ### #####o#", "## #     o  #....#", "#  ### ## o #....##", "# o   o #   #..o. #", "#  ## o #  ##.... #", "#####   ######...##", "    #####    #####"], ["  ####", "  #  #########", " ##  ##  #   #", " #  o# o@o   ####", " #o  o  # o o#  ##", "##  o## #o o     #", "#  #  # #   ooo  #", "# o    o  o## ####", "# o o #o#  #  #", "##  ###  ###o #", " #  #....     #", " ####......####", "   #....####", "   #...##", "   #...#", "   #####"], ["      ####", "  #####  #", " ##     o#", "## o  ## ###", "#@o o # o  #", "#### ##   o#", " #....#o o #", " #....#   o#", " #....  oo ##", " #... # o   #", " ######o o  #", "      #   ###", "      #o ###", "      #  #", "      ####"], [" ###########", " #     ##  #", " #   o   o #", "#### ## oo #", "#   o #    #", "# ooo # ####", "#   # # o ##", "#  #  #  o #", "# o# o#    #", "#   ..# ####", "####.. o #@#", "#.....# o# #", "##....#  o #", " ##..##    #", "  ##########"], [" #########", " #....   ##", " #.#.#  o ##", "##....# # @##", "# ....#  #  ##", "#     #o ##o #", "## ###  o    #", " #o  o o o#  #", " # #  o o ## #", " #  ###  ##  #", " #    ## ## ##", " #  o #  o  #", " ###o o   ###", "   #  #####", "   ####"], ["############ ######", "#   #    # ###....#", "#   oo#   @  .....#", "#   # ###   # ....#", "## ## ###  #  ....#", " # o o     # # ####", " #  o o##  #      #", "#### #  #### # ## #", "#  # #o   ## #    #", "# o  o  # ## #   ##", "# # o o    # #   #", "#  o ## ## # #####", "# oo     oo  #", "## ## ### o  #", " #    # #    #", " ###### ######"], ["            #####", "#####  ######   #", "#   ####  o o o #", "# o   ## ## ##  ##", "#   o o     o  o #", "### o  ## ##     ##", "  # ##### #####oo #", " ##o##### @##     #", " # o  ###o### o  ##", " # o  #   ###  ###", " # oo o #   oo #", " #     #   ##  #", " #######.. .###", "    #.........#", "    #.........#", "    ###########"], ["###########", "#......   #########", "#......   #  ##   #", "#..### o    o     #", "#... o o #   ##   #", "#...#o#####    #  #", "###    #   #o  #o #", "  #  oo o o  o##  #", "  #  o   #o#o ##o #", "  ### ## #    ##  #", "   #  o o ## ######", "   #    o  o  #", "   ##   # #   #", "    #####@#####", "        ###"], ["      ####", "####### @#", "#     o  #", "#   o## o#", "##o#...# #", " # o...  #", " # #. .# ##", " #   # #o #", " #o  o    #", " #  #######", " ####"], ["             ######", " #############....#", "##   ##     ##....#", "#  oo##  o @##....#", "#      oo o#  ....#", "#  o ## oo # # ...#", "#  o ## o  #  ....#", "## ##### ### ##.###", "##   o  o ##   .  #", "# o###  # ##### ###", "#   o   #       #", "#  o #o o o###  #", "# ooo# o   # ####", "#    #  oo #", "######   ###", "     #####"], ["    ############", "    #          ##", "    #  # #oo o  #", "    #o #o#  ## @#", "   ## ## # o # ##", "   #   o #o  # #", "   #   # o   # #", "   ## o o   ## #", "   #  #  ##  o #", "   #    ## oo# #", "######oo   #   #", "#....#  ########", "#.#... ##", "#....   #", "#....   #", "#########"], ["           #####", "          ##   ##", "         ##     #", "        ##  oo  #", "       ## oo  o #", "       # o    o #", "####   #   oo #####", "#  ######## ##    #", "#.            ooo@#", "#.# ####### ##   ##", "#.# #######. #o o##", "#........... #    #", "##############  o #", "             ##  ##", "              ####"], ["     ########", "  ####      ######", "  #    ## o o   @#", "  # ## ##o#o o o##", "### ......#  oo ##", "#   ......#  #   #", "# # ......#o  o  #", "# #o...... oo# o #", "#   ### ###o  o ##", "###  o  o  o  o #", "  #  o  o  o  o #", "  ######   ######", "       #####"], ["        #######", "    #####  #  ####", "    #   #   o    #", " #### #oo ## ##  #", "##      # #  ## ###", "#  ### o#o  o  o  #", "#...    # ##  #   #", "#...#    @ # ### ##", "#...#  ###  o  o  #", "######## ##   #   #", "          #########"], [" #####", " #   #", " # # #######", " #      o@######", " # o ##o ###   #", " # #### o    o #", " # ##### #  #o ####", "##  #### ##o      #", "#  o#  o  # ## ## #", "#         # #...# #", "######  ###  ...  #", "     #### # #...# #", "          # ### # #", "          #       #", "          #########"], ["##### ####", "#...# #  ####", "#...###  o  #", "#....## o  o###", "##....##   o  #", "###... ## o o #", "# ##    #  o  #", "#  ## # ### ####", "# o # #o  o    #", "#  o @ o    o  #", "#   # o oo o ###", "#  ######  ###", "# ##    ####", "###"], ["##########", "#        ####", "# ###### #  ##", "# # o o o  o #", "#       #o   #", "###o  oo#  ###", "  #  ## # o##", "  ##o#   o @#", "   #  o o ###", "   # #   o  #", "   # ##   # #", "  ##  ##### #", "  #         #", "  #.......###", "  #.......#", "  #########"], ["         ####", " #########  ##", "##  o      o #####", "#   ## ##   ##...#", "# #oo o oo#o##...#", "# #   @   #   ...#", "#  o# ###oo   ...#", "# o  oo  o ##....#", "###o       #######", "  #  #######", "  ####"], ["  #########", "  #*.*#*.*#", "  #.*.*.*.#", "  #*.*.*.*#", "  #.*.*.*.#", "  #*.*.*.*#", "  ###   ###", "    #   #", "###### ######", "#           #", "# o o o o o #", "## o o o o ##", " #o o o o o#", " #   o@o   #", " #  #####  #", " ####   ####"], ["       ####", "       #  ##", "       #   ##", "       # oo ##", "     ###o  o ##", "  ####    o   #", "###  # #####  #", "#    # #....o #", "# #   o ....# #", "#  o # #.*..# #", "###  #### ### #", "  #### @o  ##o##", "     ### o     #", "       #  ##   #", "       #########"], ["      ############", "     ##..    #   #", "    ##..* o    o #", "   ##..*.# # # o##", "   #..*.# # # o  #", "####...#  #    # #", "#  ## #          #", "# @o o ###  #   ##", "# o   o   # #   #", "###oo   # # # # #", "  #   o   # # #####", "  # o# #####      #", "  #o   #   #    # #", "  #  ###   ##     #", "  #  #      #    ##", "  ####      ######"]];

  Sokoban = (function() {
    var playerPos;

    Sokoban.prototype.canvas = null;

    Sokoban.prototype.canvasContext = null;

    Sokoban.prototype.image = null;

    Sokoban.prototype.map = [];

    Sokoban.prototype.level = 0;

    playerPos = [-1, -1];

    function Sokoban() {
      this.image = new Image();
      this.image.src = "tiles.png";
      this.image.onload = function() {
        this.canvas = document.getElementById("sokoban");
        this.canvas.width = 400;
        this.canvas.height = 400;
        this.canvas.tilesize = 20;
        this.canvas.addEventListener("keypress", this.handleEvent, false);
        this.canvas.focus();
        this.canvasContext = this.canvas.getContext("2d");
        this.canvasContext.font = "bold " + this.canvas.tilesize + "px sans-serif";
        return this.canvasContext.textBaseline = "top";
      };
      this.newGame;
    }

    Sokoban.prototype.handleEvent = function(event) {
      var dx, dy;
      switch (event.keyCode) {
        case 97:
        case 104:
          dy = 0;
          dx = -1;
          break;
        case 115:
        case 106:
          dy = 1;
          dx = 0;
          break;
        case 119:
        case 107:
          dy = -1;
          dx = 0;
          break;
        case 100:
        case 108:
          dy = 0;
          dx = 1;
          break;
        case 32:
          this.newGame;
          break;
        default:
          return;
      }
      switch (this.map[playerPos[0] + dy][playerPos[1] + dx]) {
        case 0:
          return this.moveObject(dy, dx, "player");
        case 2:
        case 3:
          this.moveObject(dy, dx, "crate");
          return this.moveObject(dy, dx, "player");
        case 6:
          return this.moveObject(dy, dx, "player");
      }
    };

    Sokoban.prototype.drawTile = function(y, x, token) {
      if (token == null) {
        token = this.map[y][x];
      }
      return this.canvasContext.drawImage(this.image, token * this.canvas.tilesize, 0, this.canvas.tilesize, this.canvas.tilesize, x * this.canvas.tilesize, y * this.canvas.tilesize, this.canvas.tilesize, this.canvas.tilesize);
    };

    Sokoban.prototype.newGame = function() {
      var thisMap, tmparr, token, x, y, _i, _j, _ref, _ref1;
      if (this.level === "random") {
        thisMap = gRawMaps[Math.floor(Math.random() * gRawMaps.length)];
      } else {
        thisMap = gRawMaps[this.level];
      }
      this.canvasContext.fillStyle = "grey";
      this.canvasContext.fillRect(0, 0, this.canvas.width, this.canvas.height);
      this.map = [];
      tmparr = [];
      for (y = _i = 0, _ref = thisMap.length; 0 <= _ref ? _i < _ref : _i > _ref; y = 0 <= _ref ? ++_i : --_i) {
        for (x = _j = 0, _ref1 = thisMap[y].length; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; x = 0 <= _ref1 ? ++_j : --_j) {
          switch (thisMap[y][x]) {
            case ' ':
              token = 0;
              break;
            case '#':
              token = 1;
              break;
            case 'o':
              token = 2;
              break;
            case '*':
              token = 3;
              break;
            case '@':
              token = 4;
              this.playerPos = [y, x];
              break;
            case '+':
              token = 5;
              break;
            case '.':
              token = 6;
              break;
            case 'x':
              token = 9;
          }
          tmparr.push(token);
          if (token !== 9) {
            this.drawTile(y, x, token);
          }
        }
        this.map.push(tmparr);
        tmparr = [];
      }
      this.canvasContext.fillstyle = "black";
      return this.canvasContext.fillText("Level: " + (this.level + 1) + " (press space to reset level)", 0, this.canvas.height - this.canvas.tilesize(-5));
    };

    Sokoban.prototype.moveObject = function(dy, dx, objectType) {
      var objX, objY, x, y, _i, _j, _ref, _ref1, _ref2;
      objY = this.playerPos[0];
      objX = this.playerPos[1];
      if (objectType === "crate") {
        objY += dy;
        objX += dx;
      }
      if ((_ref = this.map[objY + dy][objX + dx]) !== 0 && _ref !== 6) {
        return;
      }
      switch (this.map[objY][objX]) {
        case 2:
        case 4:
          this.map[objY][objX] = 0;
          break;
        case 3:
        case 5:
          this.map[objY][objX] = 6;
      }
      if (objectType === "player") {
        this.drawTile(objY, objX);
      }
      objY += dy;
      objX += dx;
      switch (this.map[objY][objX]) {
        case 0:
          this.map[objY][objX] = objectType === "crate" ? 2 : 4;
          break;
        case 6:
          this.map[objY][objX] = objectType === "crate" ? 3 : 5;
      }
      this.drawTile(objY(objX));
      if (objectType === "player") {
        return this.playerPos = [objY, objX];
      } else {
        if (this.map[objY][objX] === 3) {
          for (y = _i = 0, _ref1 = this.map.length; 0 <= _ref1 ? _i < _ref1 : _i > _ref1; y = 0 <= _ref1 ? ++_i : --_i) {
            for (x = _j = 0, _ref2 = this.map[y].length; 0 <= _ref2 ? _j < _ref2 : _j > _ref2; x = 0 <= _ref2 ? ++_j : --_j) {
              if (this.map[y][x] === 2) {
                return;
              }
            }
          }
          return this.newGame;
        }
      }
    };

    return Sokoban;

  })();

}).call(this);
