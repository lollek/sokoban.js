# Created by Olle Kvarnstrom 
# Date: 2013-10-01 

# Maps:
gRawMaps = [["xxxx#####"
            ,"xxxx#   #"
            ,"xxxx#o  #"
            ,"xx###  o##"
            ,"xx#  o o #"
            ,"### # ## #xxx######"
            ,"#   # ## #####  ..#"
            ,"# o  o          ..#"
            ,"##### ### #@##  ..#"
            ,"xxxx#     #########"
            ,"xxxx#######"
            ],
            ["############"
            ,"#..  #     ###"
            ,"#..  # o  o  #"
            ,"#..  #o####  #"
            ,"#..    @ ##  #"
            ,"#..  # #  o ##"
            ,"###### ##o o #"
            ,"xx# o  o o o #"
            ,"xx#    #     #"
            ,"xx############"
            ],
            ["xxxxxxxx########"
            ,"xxxxxxxx#     @#"
            ,"xxxxxxxx# o#o ##"
            ,"xxxxxxxx# o  o#"
            ,"xxxxxxxx##o o #"
            ,"######### o # ###"
            ,"#....  ## o  o  #"
            ,"##...    o  o   #"
            ,"#....  ##########"
            ,"########"
            ],
            ["xxxxxxxxxxx########"
            ,"xxxxxxxxxxx#  ....#"
            ,"############  ....#"
            ,"#    #  o o   ....#"
            ,"# ooo#o  o #  ....#"
            ,"#  o     o #  ....#"
            ,"# oo #o o o########"
            ,"#  o #     #"
            ,"## #########"
            ,"#    #    ##"
            ,"#     o   ##"
            ,"#  oo#oo  @#"
            ,"#    #    ##"
            ,"###########"
            ],
            ["xxxxxxxx#####"
            ,"xxxxxxxx#   #####"
            ,"xxxxxxxx# #o##  #"
            ,"xxxxxxxx#     o #"
            ,"######### ###   #"
            ,"#....  ## o  o###"
            ,"#....    o oo ##"
            ,"#....  ##o  o @#"
            ,"#########  o  ##"
            ,"xxxxxxxx# o o  #"
            ,"xxxxxxxx### ## #"
            ,"xxxxxxxxxx#    #"
            ,"xxxxxxxxxx######"
            ],
            ["######xx###"
            ,"#..  #x##@##"
            ,"#..  ###   #"
            ,"#..     oo #"
            ,"#..  # # o #"
            ,"#..### # o #"
            ,"#### o #o  #"
            ,"xxx#  o# o #"
            ,"xxx# o  o  #"
            ,"xxx#  ##   #"
            ,"xxx#########"
            ],
            ["xxxxxxx#####"
            ,"x#######   ##"
            ,"## # @## oo #"
            ,"#    o      #"
            ,"#  o  ###   #"
            ,"### #####o###"
            ,"# o  ### ..#"
            ,"# o o o ...#"
            ,"#    ###...#"
            ,"# oo # #...#"
            ,"#  ### #####"
            ,"####"
            ],
            ["xx####"
            ,"xx#  ###########"
            ,"xx#    o   o o #"
            ,"xx# o# o #  o  #"
            ,"xx#  o o  #    #"
            ,"### o# #  #### #"
            ,"#@#o o o  ##   #"
            ,"#    o #o#   # #"
            ,"#   o    o o o #"
            ,"#####  #########"
            ,"xx#      #"
            ,"xx#      #"
            ,"xx#......#"
            ,"xx#......#"
            ,"xx#......#"
            ,"xx########"
            ],
            ["xxxxxxxxxx#######"
            ,"xxxxxxxxxx#  ...#"
            ,"xxxxxx#####  ...#"
            ,"xxxxxx#      . .#"
            ,"xxxxxx#  ##  ...#"
            ,"xxxxxx## ##  ...#"
            ,"xxxxx### ########"
            ,"xxxxx# ooo ##"
            ,"x#####  o o #####"
            ,"##   #o o   #   #"
            ,"#@ o  o    o  o #"
            ,"###### oo o #####"
            ,"xxxxx#      #"
            ,"xxxxx########"
            ],
            [" ###  #############"
            ,"##@####       #   #"
            ,"# oo   oo  o o ...#"
            ,"#  ooo#    o  #...#"
            ,"# o   # oo oo #...#"
            ,"###   #  o    #...#"
            ,"#     # o o o #...#"
            ,"#    ###### ###...#"
            ,"## #  #  o o  #...#"
            ,"#  ## # oo o o##..#"
            ,"# ..# #  o      #.#"
            ,"# ..# # ooo ooo #.#"
            ,"##### #       # #.#"
            ,"    # ######### #.#"
            ,"    #           #.#"
            ,"    ###############"
            ],
            ["          ####"
            ,"     #### #  #"
            ,"   ### @###o #"
            ,"  ##      o  #"
            ," ##  o oo## ##"
            ," #  #o##     #"
            ," # # o oo # ###"
            ," #   o #  # o #####"
            ,"####    #  oo #   #"
            ,"#### ## o         #"
            ,"#.    ###  ########"
            ,"#.. ..# ####"
            ,"#...#.#"
            ,"#.....#"
            ,"#######"
            ],
            ["################"
            ,"#              #"
            ,"# # ######     #"
            ,"# #  o o o o#  #"
            ,"# #   o@o   ## ##"
            ,"# #  o o o###...#"
            ,"# #   o o  ##...#"
            ,"# ###ooo o ##...#"
            ,"#     # ## ##...#"
            ,"#####   ## ##...#"
            ,"    #####     ###"
            ,"        #     #"
            ,"        #######"
            ],
            ["   #########"
            ,"  ##   ##  #####"
            ,"###     #  #    ###"
            ,"#  o #o #  #  ... #"
            ,"# # o#@o## # #.#. #"
            ,"#  # #o  #    . . #"
            ,"# o    o # # #.#. #"
            ,"#   ##  ##o o . . #"
            ,"# o #   #  #o#.#. #"
            ,"## o  o   o  o... #"
            ," #o ######    ##  #"
            ," #  #    ##########"
            ," ####"
            ],
            ["       #######"
            ," #######     #"
            ," #     # o@o #"
            ," #oo #   #########"
            ," # ###......##   #"
            ," #   o......## # #"
            ," # ###......     #"
            ,"##   #### ### #o##"
            ,"#  #o   #  o  # #"
            ,"#  o ooo  # o## #"
            ,"#   o o ###oo # #"
            ,"#####     o   # #"
            ,"    ### ###   # #"
            ,"      #     #   #"
            ,"      ########  #"
            ,"             ####"
            ],
            ["   ########"
            ,"   #   #  #"
            ,"   #  o   #"
            ," ### #o   ####"
            ," #  o  ##o   #"
            ," #  # @ o # o#"
            ," #  #      o ####"
            ," ## ####o##     #"
            ," # o#.....# #   #"
            ," #  o..**. o# ###"
            ,"##  #.....#   #"
            ,"#   ### #######"
            ,"# oo  #  #"
            ,"#  #     #"
            ,"######   #"
            ,"     #####"
            ],
            ["#####"
            ,"#   ##"
            ,"#    #  ####"
            ,"# o  ####  #"
            ,"#  oo o   o#"
            ,"###@ #o    ##"
            ," #  ##  o o ##"
            ," # o  ## ## .#"
            ," #  #o##o  #.#"
            ," ###   o..##.#"
            ,"  #    #.*...#"
            ,"  # oo #.....#"
            ,"  #  #########"
            ,"  #  #"
            ,"  ####"
            ],
            ["   ##########"
            ,"   #..  #   #"
            ,"   #..      #"
            ,"   #..  #  ####"
            ,"  #######  #  ##"
            ,"  #            #"
            ,"  #  #  ##  #  #"
            ,"#### ##  #### ##"
            ,"#  o  ##### #  #"
            ,"# # o  o  # o  #"
            ,"# @o  o   #   ##"
            ,"#### ## #######"
            ,"   #    #"
            ,"   ######"
            ],
            ["     ###########"
            ,"     #  .  #   #"
            ,"     # #.    @ #"
            ," ##### ##..# ####"
            ,"##  # ..###     ###"
            ,"# o #...   o #  o #"
            ,"#    .. ##  ## ## #"
            ,"####o##o# o #   # #"
            ,"  ## #    #o oo # #"
            ,"  #  o # #  # o## #"
            ,"  #               #"
            ,"  #  ###########  #"
            ,"  ####         ####"
            ],
            ["  ######"
            ,"  #   @####"
            ,"##### o   #"
            ,"#   ##    ####"
            ,"# o #  ##    #"
            ,"# o #  ##### #"
            ,"## o  o    # #"
            ,"## o o ### # #"
            ,"## #  o  # # #"
            ,"## # #o#   # #"
            ,"## ###   # # ######"
            ,"#  o  #### # #....#"
            ,"#    o    o   ..#.#"
            ,"####o  o# o   ....#"
            ,"#       #  ## ....#"
            ,"###################"
            ],
            ["    ##########"
            ,"#####        ####"
            ,"#     #   o  #@ #"
            ,"# #######o####  ###"
            ,"# #    ## #  #o ..#"
            ,"# # o     #  #  #.#"
            ,"# # o  #     #o ..#"
            ,"# #  ### ##     #.#"
            ,"# ###  #  #  #o ..#"
            ,"# #    #  ####  #.#"
            ,"# #o   o  o  #o ..#"
            ,"#    o # o o #  #.#"
            ,"#### o###    #o ..#"
            ,"   #    oo ###....#"
            ,"   #      ## ######"
            ,"   ########"
            ],
            ["#########"
            ,"#       #"
            ,"#       ####"
            ,"## #### #  #"
            ,"## #@##    #"
            ,"# ooo o  oo#"
            ,"#  # ## o  #"
            ,"#  # ##  o ####"
            ,"####  ooo o#  #"
            ," #   ##   ....#"
            ," # #   # #.. .#"
            ," #   # # ##...#"
            ," ##### o  #...#"
            ,"     ##   #####"
            ,"      #####"
            ],
            ["######     ####"
            ,"#    #######  #####"
            ,"#   o#  #  o  #   #"
            ,"#  o  o  o # o o  #"
            ,"##o o   # @# o    #"
            ,"#  o ########### ##"
            ,"# #   #.......# o#"
            ,"# ##  # ......#  #"
            ,"# #   o........o #"
            ,"# # o #.... ..#  #"
            ,"#  o o####o#### o#"
            ,"# o   ### o   o  ##"
            ,"# o     o o  o    #"
            ,"## ###### o ##### #"
            ,"#         #       #"
            ,"###################"
            ],
            ["    #######"
            ,"    #  #  ####"
            ,"##### o#o #  ##"
            ,"#.. #  #  #   #"
            ,"#.. # o#o #  o####"
            ,"#.  #     #o  #  #"
            ,"#..   o#  # o    #"
            ,"#..@#  #o #o  #  #"
            ,"#.. # o#     o#  #"
            ,"#.. #  #oo#o  #  ##"
            ,"#.. # o#  #  o#o  #"
            ,"#.. #  #  #   #   #"
            ,"##. ####  #####   #"
            ," ####  ####   #####"
            ],
            ["###############"
            ,"#..........  .####"
            ,"#..........oo.#  #"
            ,"###########o #   ##"
            ,"#      o  o     o #"
            ,"## ####   #  o #  #"
            ,"#      #   ##  # ##"
            ,"#  o#  # ##  ### ##"
            ,"# o #o###    ### ##"
            ,"###  o #  #  ### ##"
            ,"###    o ## #  # ##"
            ," # o  #  o  o o   #"
            ," #  o  o#ooo  #   #"
            ," #  #  o      #####"
            ," # @##  #  #  #"
            ," ##############"
            ],
            ["####"
            ,"#  ##############"
            ,"#  #   ..#......#"
            ,"#  # # ##### ...#"
            ,"##o#    ........#"
            ,"#   ##o######  ####"
            ,"# o #     ######@ #"
            ,"##o # o   ######  #"
            ,"#  o #ooo##       #"
            ,"#      #    #o#o###"
            ,"# #### #ooooo    #"
            ,"# #    o     #   #"
            ,"# #   ##        ###"
            ,"# ######o###### o #"
            ,"#        #    #   #"
            ,"##########    #####"
            ],
            [" #######"
            ," #  #  #####"
            ,"##  #  #...###"
            ,"#  o#  #...  #"
            ,"# o #oo ...  #"
            ,"#  o#  #... .#"
            ,"#   # o########"
            ,"##o       o o #"
            ,"##  #  oo #   #"
            ," ######  ##oo@#"
            ,"      #      ##"
            ,"      ########"
            ],
            [" #################"
            ," #...   #    #   ##"
            ,"##.....  o## # #o #"
            ,"#......#  o  #    #"
            ,"#......#  #  # #  #"
            ,"######### o  o o  #"
            ,"  #     #o##o ##o##"
            ," ##   o    # o    #"
            ," #  ## ### #  ##o #"
            ," # o oo     o  o  #"
            ," # o    o##o ######"
            ," #######  @ ##"
            ,"       ######"
            ],
            ["         #####"
            ,"     #####   #"
            ,"    ## o  o  ####"
            ,"##### o  o o ##.#"
            ,"#       oo  ##..#"
            ,"#  ###### ###.. #"
            ,"## #  #    #... #"
            ,"# o   #    #... #"
            ,"#@ #o ## ####...#"
            ,"####  o oo  ##..#"
            ,"   ##  o o  o...#"
            ,"    # oo  o #  .#"
            ,"    #   o o  ####"
            ,"    ######   #"
            ,"         #####"
            ],
            ["#####"
            ,"#   ##"
            ,"# o  #########"
            ,"## # #       ######"
            ,"## #   o#o#@  #   #"
            ,"#  #      o #   o #"
            ,"#  ### ######### ##"
            ,"#  ## ..*..... # ##"
            ,"## ## *.*..*.* # ##"
            ,"# o########## ##o #"
            ,"#  o   o  o    o  #"
            ,"#  #   #   #   #  #"
            ,"###################"
            ],
            ["       ###########"
            ,"       #   #     #"
            ,"#####  #     o o #"
            ,"#   ##### o## # ##"
            ,"# o ##   # ## o  #"
            ,"# o  @oo # ##ooo #"
            ,"## ###   # ##    #"
            ,"## #   ### #####o#"
            ,"## #     o  #....#"
            ,"#  ### ## o #....##"
            ,"# o   o #   #..o. #"
            ,"#  ## o #  ##.... #"
            ,"#####   ######...##"
            ,"    #####    #####"
            ],
            ["  ####"
            ,"  #  #########"
            ," ##  ##  #   #"
            ," #  o# o@o   ####"
            ," #o  o  # o o#  ##"
            ,"##  o## #o o     #"
            ,"#  #  # #   ooo  #"
            ,"# o    o  o## ####"
            ,"# o o #o#  #  #"
            ,"##  ###  ###o #"
            ," #  #....     #"
            ," ####......####"
            ,"   #....####"
            ,"   #...##"
            ,"   #...#"
            ,"   #####"
            ],
            ["      ####"
            ,"  #####  #"
            ," ##     o#"
            ,"## o  ## ###"
            ,"#@o o # o  #"
            ,"#### ##   o#"
            ," #....#o o #"
            ," #....#   o#"
            ," #....  oo ##"
            ," #... # o   #"
            ," ######o o  #"
            ,"      #   ###"
            ,"      #o ###"
            ,"      #  #"
            ,"      ####"
            ],
            [" ###########"
            ," #     ##  #"
            ," #   o   o #"
            ,"#### ## oo #"
            ,"#   o #    #"
            ,"# ooo # ####"
            ,"#   # # o ##"
            ,"#  #  #  o #"
            ,"# o# o#    #"
            ,"#   ..# ####"
            ,"####.. o #@#"
            ,"#.....# o# #"
            ,"##....#  o #"
            ," ##..##    #"
            ,"  ##########"
            ],
            [" #########"
            ," #....   ##"
            ," #.#.#  o ##"
            ,"##....# # @##"
            ,"# ....#  #  ##"
            ,"#     #o ##o #"
            ,"## ###  o    #"
            ," #o  o o o#  #"
            ," # #  o o ## #"
            ," #  ###  ##  #"
            ," #    ## ## ##"
            ," #  o #  o  #"
            ," ###o o   ###"
            ,"   #  #####"
            ,"   ####"
            ],
            ["############ ######"
            ,"#   #    # ###....#"
            ,"#   oo#   @  .....#"
            ,"#   # ###   # ....#"
            ,"## ## ###  #  ....#"
            ," # o o     # # ####"
            ," #  o o##  #      #"
            ,"#### #  #### # ## #"
            ,"#  # #o   ## #    #"
            ,"# o  o  # ## #   ##"
            ,"# # o o    # #   #"
            ,"#  o ## ## # #####"
            ,"# oo     oo  #"
            ,"## ## ### o  #"
            ," #    # #    #"
            ," ###### ######"
            ],
            ["            #####"
            ,"#####  ######   #"
            ,"#   ####  o o o #"
            ,"# o   ## ## ##  ##"
            ,"#   o o     o  o #"
            ,"### o  ## ##     ##"
            ,"  # ##### #####oo #"
            ," ##o##### @##     #"
            ," # o  ###o### o  ##"
            ," # o  #   ###  ###"
            ," # oo o #   oo #"
            ," #     #   ##  #"
            ," #######.. .###"
            ,"    #.........#"
            ,"    #.........#"
            ,"    ###########"
            ],
            ["###########"
            ,"#......   #########"
            ,"#......   #  ##   #"
            ,"#..### o    o     #"
            ,"#... o o #   ##   #"
            ,"#...#o#####    #  #"
            ,"###    #   #o  #o #"
            ,"  #  oo o o  o##  #"
            ,"  #  o   #o#o ##o #"
            ,"  ### ## #    ##  #"
            ,"   #  o o ## ######"
            ,"   #    o  o  #"
            ,"   ##   # #   #"
            ,"    #####@#####"
            ,"        ###"
            ],
            ["      ####"
            ,"####### @#"
            ,"#     o  #"
            ,"#   o## o#"
            ,"##o#...# #"
            ," # o...  #"
            ," # #. .# ##"
            ," #   # #o #"
            ," #o  o    #"
            ," #  #######"
            ," ####"
            ],
            ["             ######"
            ," #############....#"
            ,"##   ##     ##....#"
            ,"#  oo##  o @##....#"
            ,"#      oo o#  ....#"
            ,"#  o ## oo # # ...#"
            ,"#  o ## o  #  ....#"
            ,"## ##### ### ##.###"
            ,"##   o  o ##   .  #"
            ,"# o###  # ##### ###"
            ,"#   o   #       #"
            ,"#  o #o o o###  #"
            ,"# ooo# o   # ####"
            ,"#    #  oo #"
            ,"######   ###"
            ,"     #####"
            ],
            ["    ############"
            ,"    #          ##"
            ,"    #  # #oo o  #"
            ,"    #o #o#  ## @#"
            ,"   ## ## # o # ##"
            ,"   #   o #o  # #"
            ,"   #   # o   # #"
            ,"   ## o o   ## #"
            ,"   #  #  ##  o #"
            ,"   #    ## oo# #"
            ,"######oo   #   #"
            ,"#....#  ########"
            ,"#.#... ##"
            ,"#....   #"
            ,"#....   #"
            ,"#########"
            ],
            ["           #####"
            ,"          ##   ##"
            ,"         ##     #"
            ,"        ##  oo  #"
            ,"       ## oo  o #"
            ,"       # o    o #"
            ,"####   #   oo #####"
            ,"#  ######## ##    #"
            ,"#.            ooo@#"
            ,"#.# ####### ##   ##"
            ,"#.# #######. #o o##"
            ,"#........... #    #"
            ,"##############  o #"
            ,"             ##  ##"
            ,"              ####"
            ],
            ["     ########"
            ,"  ####      ######"
            ,"  #    ## o o   @#"
            ,"  # ## ##o#o o o##"
            ,"### ......#  oo ##"
            ,"#   ......#  #   #"
            ,"# # ......#o  o  #"
            ,"# #o...... oo# o #"
            ,"#   ### ###o  o ##"
            ,"###  o  o  o  o #"
            ,"  #  o  o  o  o #"
            ,"  ######   ######"
            ,"       #####"
            ],
            ["        #######"
            ,"    #####  #  ####"
            ,"    #   #   o    #"
            ," #### #oo ## ##  #"
            ,"##      # #  ## ###"
            ,"#  ### o#o  o  o  #"
            ,"#...    # ##  #   #"
            ,"#...#    @ # ### ##"
            ,"#...#  ###  o  o  #"
            ,"######## ##   #   #"
            ,"          #########"
            ],
            [" #####"
            ," #   #"
            ," # # #######"
            ," #      o@######"
            ," # o ##o ###   #"
            ," # #### o    o #"
            ," # ##### #  #o ####"
            ,"##  #### ##o      #"
            ,"#  o#  o  # ## ## #"
            ,"#         # #...# #"
            ,"######  ###  ...  #"
            ,"     #### # #...# #"
            ,"          # ### # #"
            ,"          #       #"
            ,"          #########"
            ],
            ["##### ####"
            ,"#...# #  ####"
            ,"#...###  o  #"
            ,"#....## o  o###"
            ,"##....##   o  #"
            ,"###... ## o o #"
            ,"# ##    #  o  #"
            ,"#  ## # ### ####"
            ,"# o # #o  o    #"
            ,"#  o @ o    o  #"
            ,"#   # o oo o ###"
            ,"#  ######  ###"
            ,"# ##    ####"
            ,"###"
            ],
            ["##########"
            ,"#        ####"
            ,"# ###### #  ##"
            ,"# # o o o  o #"
            ,"#       #o   #"
            ,"###o  oo#  ###"
            ,"  #  ## # o##"
            ,"  ##o#   o @#"
            ,"   #  o o ###"
            ,"   # #   o  #"
            ,"   # ##   # #"
            ,"  ##  ##### #"
            ,"  #         #"
            ,"  #.......###"
            ,"  #.......#"
            ,"  #########"
            ],
            ["         ####"
            ," #########  ##"
            ,"##  o      o #####"
            ,"#   ## ##   ##...#"
            ,"# #oo o oo#o##...#"
            ,"# #   @   #   ...#"
            ,"#  o# ###oo   ...#"
            ,"# o  oo  o ##....#"
            ,"###o       #######"
            ,"  #  #######"
            ,"  ####"
            ],
            ["  #########"
            ,"  #*.*#*.*#"
            ,"  #.*.*.*.#"
            ,"  #*.*.*.*#"
            ,"  #.*.*.*.#"
            ,"  #*.*.*.*#"
            ,"  ###   ###"
            ,"    #   #"
            ,"###### ######"
            ,"#           #"
            ,"# o o o o o #"
            ,"## o o o o ##"
            ," #o o o o o#"
            ," #   o@o   #"
            ," #  #####  #"
            ," ####   ####"
            ],
            ["       ####"
            ,"       #  ##"
            ,"       #   ##"
            ,"       # oo ##"
            ,"     ###o  o ##"
            ,"  ####    o   #"
            ,"###  # #####  #"
            ,"#    # #....o #"
            ,"# #   o ....# #"
            ,"#  o # #.*..# #"
            ,"###  #### ### #"
            ,"  #### @o  ##o##"
            ,"     ### o     #"
            ,"       #  ##   #"
            ,"       #########"
            ],
            ["      ############"
            ,"     ##..    #   #"
            ,"    ##..* o    o #"
            ,"   ##..*.# # # o##"
            ,"   #..*.# # # o  #"
            ,"####...#  #    # #"
            ,"#  ## #          #"
            ,"# @o o ###  #   ##"
            ,"# o   o   # #   #"
            ,"###oo   # # # # #"
            ,"  #   o   # # #####"
            ,"  # o# #####      #"
            ,"  #o   #   #    # #"
            ,"  #  ###   ##     #"
            ,"  #  #      #    ##"
            ,"  ####      ######"
            ]]

## redrawTile
# This functions draw a tile to the canvas. It can be called as:
# redrawTile(canvas, 14, 3), which will draw map[14][3] to canvas
# redrawTile(canvas, 14, 3, 4), which will draw a player symbol to map[14][3] 
redrawTile = (canvas, y, x, token = canvas.map[y][x]) ->
  canvas.getContext("2d").drawImage(canvas.image, 
    token * canvas.tilesize, 0, canvas.tilesize, canvas.tilesize, 
    x * canvas.tilesize, y * canvas.tilesize, canvas.tilesize, canvas.tilesize)

## newGame 
# Creates a new level (and destroys previous if existing
# level should be between  0 - gRawMaps.length-1 or "random" 
newGame =  ->
  
  canvas = document.getElementById("sokoban")
  canvasContext = canvas.getContent("2d")

  # Set thisMap to the map in gRawMaps that we want to load 
  if canvas.level == "random" 
    thisMap = gRawMaps[Math.floor(Math.random() * gRawMaps.length)]
  else
    thisMap = gRawMaps[canvas.level]

  # clear the canvas with grey paint and clear map 
  canvasContext.fillStyle = "grey"
  canvasContext.fillRect(0, 0, canvas.width, canvas.height)
  canvas.map = []

  # Create new gMap and draw it to screen 
  tmparr = []
  for y in [0...thisMap.length]
    for x in [0...thisMap[y].length]
      switch thisMap[y][x] 
        when ' ' then token = 0 # FLOOR
        when '#' then token = 1 # WALL 
        when 'o' then token = 2 # BOX
        when '*' then token = 3 # BOX IN SOCKET
        when '@'                # PLAYER 
          token = 4 
          gPlayerPos = [y, x]
        when '+' then token = 5 # PLAYER IN SOCKET
        when '.' then token = 6 # SOCKET
        when 'x' then token = 9 # INVISIBLE FLOOR
      
      tmparr.push(token);
      if (token != 9)
        redrawTile(canvas, y, x, token);
    
    gMap.push(tmparr);
    tmparr = [];

  # Write the level number
  canvasContext.fillStyle = "black"
  canvasContext.fillText(
      "Level: " + (canvas.level + 1) + " (press space to reset level)", 
      0, canvas.height-canvas.tilesize -5)


# Move player or crate
moveObject = (canvas, dy, dx, objectType) ->

  # Set objY/objX to player's
  objY = canvas.playerPos[0]
  objX = canvas.playerPos[1]

  # If object is in fact a crate instead of player, 
  # add dy/dx to get its position
  if objectType == "crate"
    objY += dy;
    objX += dx;

  # If the target tile is blocked - return
  switch canvas.map[objY + dy][objX + dx]
    when 1, 2, 3, 4, 5 then return
  
  # Remove object from old tile
  switch canvas.map[objY][objX]
    when 2, 4 then canvas.map[objY][objX] = 0
    when 3, 5 then canvas.map[objY][objX] = 6

  # Redraw if player 
  # if it's a crate, the player will soon move there anyways
  if objectType == "player"
    redrawTile(objY, objX);

  # Move the object
  objY += dy
  objX += dx

  # Add object to new tile
  switch (canvas.map[objY][objX]) 
    when 0 then canvas.map[objY][objX] = objectType == "crate" ? 2 : 4
    when 6 then canvas.map[objY][objX] = objectType == "crate" ? 3 : 5

  # Redraw tile
  redrawTile(objY, objX)

  # If object is player, update gPlayerPos
  if objectType == "player"
    gPlayerPos = [objY, objX]

  # If object is crate, check if we've won
  else if (objectType == "crate")
    if (canvas.map[objY][objX] == 3) 
      for y in [0...canvas.map.length]
        for x in [0...canvas.map[y].length]
          if canvavs.map[y][x] == 2 
            return
      newGame(++canvas.level)


# Handle events
handleEvent = (event) ->

  canvas = document.getElementById("sokoban")

  # Read wasd / hjkl or returns
  switch event.keyCode
    when 97, 104 # a/h -> moveLeft 
      dx = -1
      dy = 0
    when 115, 106 # s/j -> moveDown 
      dx = 0 
      dy = 1
    when 119, 107 # w/k -> moveUp
      dx = 0 
      dy = -1
    when 100, 108 # d/l -> moveRight
      dx = 1 
      dy = 0
    when 32 # space -> resetLevel
      newGame(canvas.map)
      return
    else return

  switch canvas.map[gPlayerPos[0] + dy][gPlayerPos[1] + dx]
    when 0 # Open ground  
      moveObject(canvas, dy, dx, "player")
    when 2, 3 # Stone / stone in place
      moveObject(canvas, dy, dx, "crate")
      moveObject(canvas, dy, dx, "player") 
    when 6 # Socket 
      moveObject(canvas, dy, dx, "player")


initMain = (level) ->

  # Load Image first
  image = new Image()
  image.src = "tiles.png"
  image.onload = ->

    canvas = document.getElementById("sokoban")
    canvas.width = 400
    canvas.height = 400
    canvas.tilesize = 20
    canvas.image = image
    canvas.level = level
    canvas.addEventListener("keypress", handleEvent, false)
    canvas.focus()
    gCanvasContext = canvas.getContext("2d")
    gCanvasContext.font = "bold " + TILE_SIZE + "px sans-serif"
    gCanvasContext.textBaseline = "top"

  newGame(canvas.level)

